#!/usr/bin/env python

import gevent.monkey

gevent.monkey.patch_all()

import bottle
import sys
import os
import multiprocessing

sys.path.insert(0, os.getcwd())

def get_server_opts(override):
    worker_class = 'geventwebsocket.gunicorn.workers.GeventWebSocketWorker'
    default = bottle.ConfigDict()
    default.update({
        'server': 'gunicorn',
        'workers': multiprocessing.cpu_count() * 2 + 1,
        'worker_class': worker_class,
        'preload_app': True,
        'debug': False,
        'pythonpath': os.getcwd(),
        'host': '0.0.0.0',
        'port': os.environ.get('PORT', 8000),
        'prefix': ''
    })
    default.update(override)
    return default


if __name__ == '__main__':
	import config
	app = bottle.Bottle()
	SERVER_OPTS = get_server_opts(getattr(config, 'SERVER', {}))
	SERVER_OPTS.pop('prefix')
	bottle.run(app=app, **SERVER_OPTS)
